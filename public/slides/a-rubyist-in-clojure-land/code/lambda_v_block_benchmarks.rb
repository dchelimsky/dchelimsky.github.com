require 'benchmark'

n = 100

puts "RUBY_VERSION: #{RUBY_VERSION}"
puts

def matches_lambda?(str)
  lambda {|re| re =~ str}
end

def matches_Proc?(str)
  Proc.new {|re| re =~ str}
end

def matches_proc?(str)
  proc {|re| re =~ str}
end

if RUBY_VERSION.to_f >= 1.9
  eval <<-STR
    def matches_lambda_with_new_syntax?(str)
      ->(re) { re =~ str }
    end
  STR
end

Benchmark.benchmark do |bm|
  if RUBY_VERSION.to_f >= 1.9
    puts "->(){}"
    3.times do
      bm.report do
        n.times do
          [/abc/, /def/, /ghi/].any? &matches_lambda_with_new_syntax?("fghi")
        end
      end
    end
  puts
  end

  puts "lambda"
  3.times do
    bm.report do
      n.times do
        [/abc/, /def/, /ghi/].any? &matches_lambda?("fghi")
      end
    end
  end

  puts
  puts "Proc.new"
  3.times do
    bm.report do
      n.times do
        [/abc/, /def/, /ghi/].any? &matches_Proc?("fghi")
      end
    end
  end

  puts
  puts "proc"
  3.times do
    bm.report do
      n.times do
        [/abc/, /def/, /ghi/].any? &matches_proc?("fghi")
      end
    end
  end

  puts
  puts "block"
  3.times do
    bm.report do
      n.times do
        [/abc/, /def/, /ghi/].any? {|re| re =~ "fghi"}
      end
    end
  end
end

__END__

RUBY_VERSION: 1.8.7

block 47% faster than lambda

1 - (0.025676 + 0.026910 + 0.025843) / (0.046834 + 0.046798 + 0.053092) = .465465772

lambda
  0.050000   0.000000   0.050000 (  0.046834)
  0.040000   0.000000   0.040000 (  0.046798)
  0.050000   0.000000   0.050000 (  0.053092)

Proc.new
  0.060000   0.000000   0.060000 (  0.057497)
  0.050000   0.000000   0.050000 (  0.048819)
  0.050000   0.000000   0.050000 (  0.049482)

proc
  0.050000   0.000000   0.050000 (  0.046900)
  0.050000   0.000000   0.050000 (  0.049745)
  0.050000   0.000000   0.050000 (  0.053274)

block
  0.020000   0.000000   0.020000 (  0.025676)
  0.030000   0.000000   0.030000 (  0.026910)
  0.030000   0.000000   0.030000 (  0.025843)


RUBY_VERSION: 1.9.3

block 31% faster than lambda

1 - (0.027551 + 0.028228 + 0.026352) / (0.043249 + 0.037151 + 0.038821) = .31110291

->(){}
   0.040000   0.000000   0.040000 (  0.043249)
   0.040000   0.000000   0.040000 (  0.037151)
   0.030000   0.000000   0.030000 (  0.038821)

lambda
   0.040000   0.000000   0.040000 (  0.037368)
   0.040000   0.000000   0.040000 (  0.043313)
   0.040000   0.000000   0.040000 (  0.039716)

Proc.new
   0.050000   0.000000   0.050000 (  0.048435)
   0.040000   0.000000   0.040000 (  0.041599)
   0.040000   0.000000   0.040000 (  0.042147)

proc
   0.040000   0.000000   0.040000 (  0.040142)
   0.040000   0.010000   0.050000 (  0.038847)
   0.040000   0.000000   0.040000 (  0.037449)

block
   0.030000   0.000000   0.030000 (  0.027551)
   0.020000   0.000000   0.020000 (  0.028228)
   0.030000   0.000000   0.030000 (  0.026352)


RUBY_VERSION: 2.0.0

block 26% faster than lambda using ->(){}

1 - (0.030856 + 0.031580 + 0.027776) / (0.041974 + 0.038884 + 0.041700) = .26392402

->(){}
   0.040000   0.000000   0.040000 (  0.041974)
   0.040000   0.000000   0.040000 (  0.038884)
   0.040000   0.000000   0.040000 (  0.041700)

lambda
   0.050000   0.000000   0.050000 (  0.044863)
   0.050000   0.000000   0.050000 (  0.051926)
   0.040000   0.000000   0.040000 (  0.047015)

Proc.new
   0.050000   0.000000   0.050000 (  0.043957)
   0.040000   0.000000   0.040000 (  0.045423)
   0.050000   0.010000   0.060000 (  0.043224)

proc
   0.040000   0.000000   0.040000 (  0.043108)
   0.050000   0.000000   0.050000 (  0.049313)
   0.040000   0.000000   0.040000 (  0.043998)

block
   0.030000   0.000000   0.030000 (  0.030856)
   0.030000   0.000000   0.030000 (  0.031580)
   0.030000   0.000000   0.030000 (  0.027776)
